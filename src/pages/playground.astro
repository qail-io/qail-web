---
import BaseLayout from '../layouts/BaseLayout.astro';
---

<BaseLayout title="QAIL Playground ‚Äî One Syntax, 19 Databases" description="Try QAIL in the interactive playground. Transpile to 19 different database formats in real-time.">
    <style is:global>
        .demo-page {
            padding: 120px 0 60px;
        }

        .qail-input-section {
            background: var(--bg-card);
            border: 2px solid var(--accent-cyan);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 48px;
            box-shadow: 0 0 60px rgba(0, 240, 255, 0.1);
        }

        .qail-input-section h2 {
            color: var(--accent-cyan);
            margin-bottom: 16px;
            font-size: 1.5rem;
        }

        .qail-input {
            width: 100%;
            background: var(--bg-code);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 20px;
            font-family: var(--font-mono);
            font-size: 1.25rem;
            color: var(--accent-cyan);
            outline: none;
        }

        .qail-input:focus {
            border-color: var(--accent-cyan);
        }

        .dialect-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        @media (max-width: 500px) {
            .dialect-grid {
                grid-template-columns: 1fr;
            }
        }

        .dialect-card {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .dialect-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            font-weight: 600;
        }

        .dialect-header img {
            width: 20px;
            height: 20px;
            max-width: 20px;
            max-height: 20px;
            object-fit: contain;
        }

        .dialect-header svg {
            width: 20px;
            height: 20px;
        }

        .dialect-header .type-badge {
            margin-left: auto;
            font-size: 0.7rem;
            padding: 3px 8px;
            border-radius: 999px;
            background: rgba(0, 240, 255, 0.15);
            color: var(--accent-cyan);
        }

        .dialect-header .type-badge.nosql {
            background: rgba(168, 85, 247, 0.15);
            color: var(--accent-purple);
        }

        .dialect-output {
            padding: 16px;
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #e6edf3;
            white-space: pre-wrap;
            word-break: break-word;
            min-height: 80px;
            max-height: 180px;
            overflow-y: auto;
            background: #161b22;
            border-radius: 0 0 12px 12px;
            margin: 0;
        }

        .dialect-output::selection {
            background: rgba(0, 240, 255, 0.3);
        }

        .section-divider {
            text-align: center;
            margin: 48px 0 32px;
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .section-divider span {
            background: var(--bg-dark);
            padding: 0 16px;
            position: relative;
        }

        .section-divider::before {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            top: 50%;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            z-index: -1;
        }

        .try-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .try-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-family: var(--font-mono);
            cursor: pointer;
            transition: var(--transition);
        }

        .try-btn:hover {
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
        }
    </style>

    <main class="demo-page">
        <div class="container">
            <header style="text-align: center; margin-bottom: 48px;">
                <h1 style="font-size: 2.5rem; margin-bottom: 8px;">One AST. <span class="highlight">5
                        Databases.</span></h1>
                <p style="color: var(--text-secondary); font-size: 1.1rem;">Write QAIL once, compile to any supported
                    database format instantly.</p>
            </header>

            <div class="qail-input-section">
                <h2>ü™ù QAIL Input</h2>
                <input type="text" class="qail-input" id="qailInput"
                    value="get users fields id, name, email where active = true and age > 18 limit 10"
                    placeholder="Enter QAIL query...">
                <div class="try-examples">
                    <span style="color: var(--text-secondary); font-size: 0.85rem; margin-right: 8px;">Try:</span>
                    <button class="try-btn" onclick='setQuery("get users fields *")'>Simple SELECT</button>
                    <button class="try-btn"
                        onclick='setQuery("get users fields id, name where active = true limit 10")'>Filtered</button>
                    <button class="try-btn"
                        onclick='setQuery("get orders fields customer_id, sum(total) where status = complete")'>Aggregate</button>
                    <button class="try-btn"
                        onclick='setQuery("add users values name = John, email = john@test.com")'>INSERT</button>
                    <button class="try-btn"
                        onclick='setQuery("set users values status = active where id = 123")'>UPDATE</button>
                </div>
            </div>

            <div class="section-divider" style="position: relative;">
                <span>SQL-AST (Tier 1)</span>
            </div>

            <div class="dialect-grid" id="sqlDialects">
                <!-- Generated by JS -->
            </div>

            <div class="section-divider" style="position: relative;">
                <span>Document-AST (Tier 2)</span>
            </div>

            <div class="dialect-grid" id="nosqlDialects">
                <!-- Generated by JS -->
            </div>
        </div>
    </main>

    <script type="module" is:inline>
        import init, {
            parse_and_transpile,
            parse_and_transpile_with_dialect,
            validate,
            version,
            to_mongo,
            to_dynamo,
            to_qdrant
        } from '/qail_wasm.js';

        const SQL_DIALECTS = [
            { name: 'PostgreSQL', key: 'postgres', icon: '/icons/postgresql.svg' },
            { name: 'SQLite', key: 'sqlite', icon: '/icons/sqlite.svg' },
        ];

        const NOSQL_DIALECTS = [
            { name: 'MongoDB', key: 'mongo', fn: to_mongo, icon: '/icons/mongodb.svg' },
            { name: 'DynamoDB', key: 'dynamo', fn: to_dynamo, icon: '/icons/dynamodb.svg' },
            { name: 'Qdrant', key: 'qdrant', fn: to_qdrant, icon: '/icons/qdrant.svg' },
        ];

        let wasmReady = false;

        function renderIcon(icon) {
            return `<img src="${icon}" alt="" width="20" height="20">`;
        }

        function createDialectCard(dialect, isNoSql = false) {
            return `
                <div class="dialect-card">
                    <div class="dialect-header">
                        ${renderIcon(dialect.icon)}
                        <span>${dialect.name}</span>
                        <span class="type-badge ${isNoSql ? 'nosql' : ''}">${isNoSql ? 'NoSQL' : 'SQL'}</span>
                    </div>
                    <div class="dialect-output" id="output-${dialect.key}">Loading...</div>
                </div>
            `;
        }

        function transpile(query, dialect) {
            if (!wasmReady) return 'Loading WASM...';
            try {
                return parse_and_transpile_with_dialect(query, dialect);
            } catch (e) {
                return `Error: ${e.message || e}`;
            }
        }

        function transpileNoSql(query, fn) {
            if (!wasmReady) return 'Loading WASM...';
            try {
                return fn(query);
            } catch (e) {
                return `Error: ${e.message || e}`;
            }
        }

        function updateOutputs() {
            const query = document.getElementById('qailInput').value;

            // SQL dialects - live transpilation
            SQL_DIALECTS.forEach(d => {
                const el = document.getElementById(`output-${d.key}`);
                if (el) el.textContent = transpile(query, d.key);
            });

            // NoSQL dialects - live transpilation!
            NOSQL_DIALECTS.forEach(d => {
                const el = document.getElementById(`output-${d.key}`);
                if (el) el.textContent = transpileNoSql(query, d.fn);
            });
        }

        window.setQuery = function (q) {
            document.getElementById('qailInput').value = q;
            updateOutputs();
        }

        async function initApp() {
            // Render cards
            document.getElementById('sqlDialects').innerHTML = SQL_DIALECTS.map(d => createDialectCard(d, false)).join('');
            document.getElementById('nosqlDialects').innerHTML = NOSQL_DIALECTS.map(d => createDialectCard(d, true)).join('');

            // Initialize WASM
            try {
                await init();
                wasmReady = true;
                console.log('QAIL WASM loaded, version:', version());
                updateOutputs();
            } catch (e) {
                console.error('Failed to load WASM:', e);
                document.querySelectorAll('.dialect-output').forEach(el => {
                    el.textContent = 'Failed to load WASM';
                });
            }

            // Live update on input
            document.getElementById('qailInput').addEventListener('input', updateOutputs);
        }

        initApp();
    </script>
</BaseLayout>
